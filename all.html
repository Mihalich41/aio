<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="styles.css">
    <title>Все возможности</title>
</head>
<body>

<header>
    <div class="logo">KVAZIGAME</div>
    <a href="#" class="back-link">< назад</a>
</header>

<script>
// Расширяем на весь экран
const tg = window.Telegram.WebApp;
tg.expand();

async function loadData() {
    try {
        // Получаем username из Telegram
        const userData = tg.initDataUnsafe;
        let username = userData?.user?.username || 'Гость';

        // Загружаем и обрабатываем JSON как строку
        const response = await fetch('all.json');
        const jsonText = await response.text();
        const data = JSON.parse(jsonText.replace(/@username/g, '@' + username));

        // Создаем div элементы на основе данных
        data.forEach(item => {
            const newDiv = document.createElement('div');
            newDiv.classList.add('panel');
            newDiv.id = item.id;

            const h1 = document.createElement('h1');
            h1.innerHTML = item.h1;
            newDiv.appendChild(h1);

            const h2 = document.createElement('h2');
            h2.innerHTML = item.h2;
            if (item.h2class) {
                h2.classList.add(item.h2class);
            }
            newDiv.appendChild(h2);

            // Добавляем форму для всех div кроме div0
            if (item.id !== 'div0') {
                const form = document.createElement('form');
                form.innerHTML = `
                    <textarea id="message_${item.id}" placeholder="Ваши пожелания или вопросы" required></textarea>
                `;
                newDiv.appendChild(form);
            }

            item.buttons?.forEach(buttonData => {
                const p = document.createElement('p');
                const button = document.createElement('button');
                button.classList.add(buttonData.class);
                button.textContent = buttonData.text;
                
                // Добавляем обработчик для кнопки "Приобрести"
                if (buttonData.class === 'purchase') {
                    button.addEventListener('click', async () => {
                        const messageText = document.getElementById(`message_${item.id}`).value;
                        const data = {
                            username: '@' + username,
                            course: item.h1,
                            message: messageText
                        };

                        try {
                            const response = await fetch('https://functions.yandexcloud.net/d4eno726s7f0too863f7', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data)
                            });

                            if (response.ok) {
                                alert('Заявка отправлена успешно!');
                            } else {
                                alert('Произошла ошибка при отправке заявки');
                            }
                        } catch (error) {
                            console.error('Ошибка:', error);
                            alert('Произошла ошибка при отправке заявки');
                        }
                    });
                }
                
                p.appendChild(button);
                newDiv.appendChild(p);
            });

            document.body.appendChild(newDiv);
        });

        // Скрыть все панели, кроме первой (div0)
        const panels = document.querySelectorAll('.panel');
        panels.forEach(panel => {
            panel.style.display = 'none';
        });
        document.getElementById('div0').style.display = 'block';

        // Обработчик кликов по кнопкам навигации
        document.querySelectorAll('button').forEach(button => {
            button.addEventListener('click', e => {
                if (e.target.classList.contains('purchase')) return; // Пропускаем кнопки покупки
                
                const targetPanelClass = e.target.classList[0];
                panels.forEach(panel => {
                    panel.style.display = 'none';
                });

                const targetPanel = document.querySelector(`#${targetPanelClass}`);
                if (targetPanel) {
                    targetPanel.style.display = 'block';
                }
            });
        });

        // Обработчик для кнопки "назад"
        document.querySelector('.back-link').addEventListener('click', (e) => {
            e.preventDefault();
            const currentPanel = document.querySelector('.panel[style*="block"]');
            if (currentPanel && currentPanel.id !== 'div0') {
                document.querySelectorAll('.panel').forEach(panel => {
                    panel.style.display = 'none';
                });
                document.getElementById('div0').style.display = 'block';
            } else {
                window.history.back();
            }
        });

    } catch (error) {
        console.error('Ошибка при загрузке данных:', error);
    }
}

// Загружаем данные
loadData();
</script>

</body>
</html>